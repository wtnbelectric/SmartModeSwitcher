# 🚦 フェーズ3 開発仕様 & 開発順序ガイドライン

## 🎯 フェーズ3の目的
- 登録済みの位置情報（緯度・経度・半径）を利用して **ジオフェンス判定を有効化**  
- 「時間帯ルールをベース」とし、「場所ルールで上書き」する挙動を実現する  

---

## ルール適用仕様（確定）

### 基本ロジック
- **時間帯ルールが常にベース**
- **場所ルールは時間帯ルールに上書き適用**

### フロー
1. **時間判定**
   - 現在時刻が一致する時間帯ルールを抽出  

2. **場所判定**
   - 該当する時間帯ルールの中で、位置情報が設定されているものをチェック  
   - Geofenceで「エリア内」にいる場合 → その場所ルールを優先適用  
   - エリア外に出た場合 → **ベースの時間帯ルールにリセット**  

### 優先順位
- 場所ルール ＞ 時間帯ルール  
- 場所ルール同士が競合した場合 → **最後に入ったエリアを優先**  

---

## ガントチャート反映（ダッシュボード）

- **時間帯ルール** → 通常の横棒表示  
- **場所ルール** → 横棒に 📍 アイコンやラベルを追加  
- **現在適用中のルール** → 太線や枠でハイライト表示  

---

## ユーザー体験例

- 09:00〜18:00 → マナーモード（時間帯ルール）  
- 📍会社（半径100m） → サイレント（場所ルール）  

挙動：
- 09:00〜18:00の間は「マナーモード」  
- 会社に入ると「サイレント」に上書き  
- 会社を出ると「マナーモード」にリセット  

---

## 開発順序（フェーズ3）

### Step 1. 権限対応
- `ACCESS_FINE_LOCATION` / `ACCESS_COARSE_LOCATION`  
- Android 10+ → `ACCESS_BACKGROUND_LOCATION`  

### Step 2. Geofence導入
- `GeofencingClient` を利用  
- ルールごとに座標＋半径を登録  
- `BroadcastReceiver` で ENTER / EXIT イベントを受信  

### Step 3. イベントハンドリング
- ENTER → 場所ルールを適用（モード切替）  
- EXIT → ベースの時間帯ルールにリセット  

### Step 4. ダッシュボード拡張
- 「現在の位置に基づく有効ルール」を表示  
- ガントチャートで現在適用中のルールをハイライト  

### Step 5. テスト & 検証
- エリアに入る/出る時に正しく切替されるか  
- 競合ルール時に優先順位通りに動作するか  
- ダッシュボードに正しく反映されるか  

---

## ✅ フェーズ3終了後にできること
- 登録した位置情報エリアに入ると自動でモードが切替  
- エリアを出るとベースの時間帯ルールにリセット  
- ダッシュボード上で「現在有効なルール」を直感的に確認可能  
